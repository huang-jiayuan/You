<!DOCTYPE html>
<html>
<head>
    <title>标签筛选测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .loading { color: #007bff; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .tag-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; }
        .tag-btn { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; }
        .tag-btn:hover { background: #f0f0f0; }
        .tag-btn.active { background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>房间标签筛选功能测试</h1>
    
    <div class="test-section">
        <h2>标签筛选测试</h2>
        <p>点击下面的标签按钮测试筛选功能：</p>
        
        <div class="tag-buttons">
            <button class="tag-btn" data-tag-id="1">娱乐</button>
            <button class="tag-btn" data-tag-id="2">才艺</button>
            <button class="tag-btn" data-tag-id="3">交友速配</button>
            <button class="tag-btn" data-tag-id="4">音乐</button>
            <button class="tag-btn" data-tag-id="5">聊天</button>
            <button class="tag-btn" data-tag-id="6">陪伴</button>
        </div>
        
        <div id="filterResult" class="result">点击标签开始测试...</div>
    </div>
    
    <div class="test-section">
        <h2>推荐房间对比</h2>
        <button class="button" onclick="testRecommendRooms()">获取推荐房间（对比用）</button>
        <div id="recommendResult" class="result"></div>
    </div>

    <script>
        let currentActiveTag = null;
        
        // 为所有标签按钮添加点击事件
        document.querySelectorAll('.tag-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tagId = parseInt(this.dataset.tagId);
                const tagName = this.textContent;
                
                // 更新按钮状态
                document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // 执行筛选测试
                testFilterByTag(tagId, tagName);
            });
        });
        
        // 测试标签筛选
        async function testFilterByTag(tagId, tagName) {
            const resultDiv = document.getElementById('filterResult');
            resultDiv.innerHTML = `<span class="loading">正在筛选标签"${tagName}"（ID: ${tagId}）...</span>`;
            
            try {
                const requestData = { 
                    tag_id: tagId,  // 使用后端期望的字段名
                    page: 1, 
                    page_size: 10   // 使用后端期望的字段名
                };
                
                console.log('发送标签筛选请求:', requestData);
                
                const response = await fetch('/api/room/getRoomsByCategory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('标签筛选响应:', data);
                
                let roomCount = 0;
                let roomsData = [];
                
                if (data.data && data.data.rooms) {
                    roomsData = data.data.rooms;
                    roomCount = roomsData.length;
                } else if (data.rooms) {
                    roomsData = data.rooms;
                    roomCount = roomsData.length;
                }
                
                resultDiv.innerHTML = `
                    <div class="success">✓ 标签"${tagName}"筛选完成</div>
                    <p><strong>标签ID:</strong> ${tagId}</p>
                    <p><strong>状态码:</strong> ${data.code}</p>
                    <p><strong>消息:</strong> ${data.msg}</p>
                    <p><strong>房间数量:</strong> ${roomCount}</p>
                    
                    ${roomCount > 0 ? `
                        <h4>房间列表:</h4>
                        <ul>
                            ${roomsData.map(room => `
                                <li>
                                    <strong>${room.room_name || room.name || '未命名房间'}</strong>
                                    <br>ID: ${room.id || room.room_id}
                                    <br>标签: ${room.tag_name || room.tag || '无'}
                                    <br>用户数: ${room.fk_member_room || room.user_count || 0}
                                    <br>房主: ${room.owner_nickname || '未知'}
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p style="color: orange;">该标签下暂无房间</p>'}
                    
                    <details>
                        <summary>查看完整响应数据</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
                if (data.code === 200) {
                    resultDiv.style.backgroundColor = '#d4edda';
                } else {
                    resultDiv.style.backgroundColor = '#f8d7da';
                }
                
            } catch (error) {
                console.error('标签筛选失败:', error);
                resultDiv.innerHTML = `
                    <div class="error">✗ 标签筛选失败: ${error.message}</div>
                `;
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        // 测试推荐房间（对比用）
        async function testRecommendRooms() {
            const resultDiv = document.getElementById('recommendResult');
            resultDiv.innerHTML = '<span class="loading">正在获取推荐房间...</span>';
            
            try {
                const response = await fetch('/api/room/getRecommendRooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page: 1, page_size: 10 })
                });
                
                const data = await response.json();
                console.log('推荐房间响应:', data);
                
                let roomCount = 0;
                let roomsData = [];
                
                if (data.data && data.data.rooms) {
                    roomsData = data.data.rooms;
                    roomCount = roomsData.length;
                }
                
                resultDiv.innerHTML = `
                    <div class="success">✓ 推荐房间获取成功</div>
                    <p><strong>状态码:</strong> ${data.code}</p>
                    <p><strong>房间数量:</strong> ${roomCount}</p>
                    
                    ${roomCount > 0 ? `
                        <h4>推荐房间列表:</h4>
                        <ul>
                            ${roomsData.map(room => `
                                <li>
                                    <strong>${room.room_name || room.name}</strong>
                                    <br>ID: ${room.id || room.room_id}
                                    <br>标签: ${room.tag_name || room.tag}
                                    <br>用户数: ${room.fk_member_room || room.user_count}
                                    <br>房主: ${room.owner_nickname}
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                    
                    <details>
                        <summary>查看完整响应数据</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
                resultDiv.style.backgroundColor = '#d4edda';
                
            } catch (error) {
                console.error('获取推荐房间失败:', error);
                resultDiv.innerHTML = `<div class="error">✗ 获取推荐房间失败: ${error.message}</div>`;
                resultDiv.style.backgroundColor = '#f8d7da';
            }
        }
        
        // 页面加载时自动测试推荐房间
        window.onload = function() {
            testRecommendRooms();
        };
    </script>
</body>
</html>