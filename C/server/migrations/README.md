# 麦位管理数据库迁移文档

## 概述

本文档描述了麦位管理功能所需的数据库表结构和迁移脚本。

## 创建的迁移文件

### 1. create_user_table.sql
- 创建用户基础表
- 包含用户基本信息和状态管理
- 为其他表的外键约束提供基础

### 2. create_room_table.sql
- 创建房间基础信息表
- 包含房间名称、类型、状态、公告等信息
- 支持房间的完整生命周期管理

### 3. create_room_member_table.sql
- 创建房间成员表
- 管理用户在房间中的角色和权限
- 支持禁言功能和时间管理
- 包含角色检查约束：0-普通用户，1-管理员，2-房主

### 4. create_room_mic_table.sql
- 创建麦位管理表
- 支持8个麦位的状态管理
- 包含麦位锁定功能
- 优化的索引设计支持高效查询

### 5. create_mic_application_table.sql (已存在，已优化)
- 麦位申请表
- 支持申请状态跟踪
- 包含处理者信息和拒绝原因
- 优化的索引设计支持快速查询

### 6. create_user_room_table.sql (已存在)
- 用户房间关系表
- 跟踪用户在线状态

## 数据库设计特点

### 索引优化
- **复合索引**: 为常用查询组合创建复合索引
- **单列索引**: 为频繁查询的单列创建索引
- **唯一约束**: 防止数据重复和保证数据完整性

### 外键约束
- **级联删除**: 房间删除时自动清理相关数据
- **SET NULL**: 用户删除时将相关记录的用户ID设为NULL
- **引用完整性**: 确保数据关系的一致性

### 数据完整性检查
- **状态值检查**: 使用CHECK约束限制状态字段的有效值
- **麦位位置检查**: 确保麦位序号在1-8范围内
- **角色权限检查**: 限制用户角色的有效值

## 执行顺序

使用 `run_all_migrations.sql` 按正确顺序执行所有迁移：

1. 用户表 (无依赖)
2. 房间表 (依赖用户表)
3. 房间成员表 (依赖用户表和房间表)
4. 麦位管理表 (依赖用户表和房间表)
5. 麦位申请表 (依赖用户表和房间表)
6. 用户房间关系表 (依赖用户表和房间表)

## 性能优化

### 查询优化索引
- `idx_room_mic_room_status`: 支持按房间查询可用麦位
- `idx_mic_application_room_status`: 支持查询房间待处理申请
- `idx_room_member_room_role`: 支持权限验证查询

### 存储引擎
- 使用InnoDB引擎支持事务和外键约束
- UTF8MB4字符集支持完整的Unicode字符

## 数据模型对应

所有数据库表都有对应的Go结构体定义在 `models/room.go` 中：
- `Room` -> `room` 表
- `RoomMember` -> `room_member` 表  
- `RoomMic` -> `room_mic` 表
- `MicApplication` -> `mic_application` 表
- `UserRoom` -> `user_room` 表

## 使用说明

1. 确保MySQL数据库已创建
2. 执行 `run_all_migrations.sql` 创建所有表
3. 验证表结构和约束是否正确创建
4. 开始使用麦位管理功能