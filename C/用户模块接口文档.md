# 用户模块接口文档

## 1. 模块概述

用户模块是即时通讯系统的核心模块之一，负责处理用户注册、登录、信息管理、关注关系等功能。该模块为整个系统提供用户身份认证和基础信息服务。

### 1.1 主要功能
- 用户注册与登录认证
- 用户信息管理与完善
- 密码管理与修改
- 用户关注关系管理
- 短信验证码服务
- JWT令牌管理

### 1.2 业务场景
- 新用户注册流程
- 用户登录验证
- 个人信息维护
- 社交关系建立
- 安全认证管理

### 1.3 相关依赖
- **数据库**：MySQL（用户信息存储）
- **缓存**：Redis（会话管理、验证码缓存）
- **第三方服务**：短信服务、实名认证服务
- **认证服务**：JWT令牌生成与验证

## 2. 接口列表

### 2.1 认证相关接口
| 接口名称 | 方法 | 路径 | 优先级 | 描述 |
|---------|------|------|--------|------|
| 发送短信验证码 | POST | /api/user/send-sms | 高 | 发送注册/登录验证码 |
| 验证码登录 | POST | /api/user/login | 高 | 使用手机号和验证码登录 |
| 密码登录 | POST | /api/user/password-login | 高 | 使用用户名和密码登录 |
| 修改密码 | POST | /api/user/update-password | 中 | 修改用户登录密码 |

### 2.2 用户信息接口
| 接口名称 | 方法 | 路径 | 优先级 | 描述 |
|---------|------|------|--------|------|
| 完善用户信息 | POST | /api/user/improve-info | 中 | 更新用户个人信息 |
| 获取用户信息 | GET | /api/user/profile | 中 | 获取当前用户信息 |
| 获取用户详情 | GET | /api/user/{user_id} | 中 | 获取指定用户信息 |

### 2.3 社交关系接口
| 接口名称 | 方法 | 路径 | 优先级 | 描述 |
|---------|------|------|--------|------|
| 关注用户 | POST | /api/user/follow | 中 | 关注指定用户 |
| 取消关注 | POST | /api/user/unfollow | 中 | 取消关注指定用户 |
| 获取关注列表 | GET | /api/user/following | 低 | 获取用户关注列表 |
| 获取粉丝列表 | GET | /api/user/followers | 低 | 获取用户粉丝列表 |

## 3. 接口详细说明

### 3.1 发送短信验证码

#### 基本信息
- **方法**：POST
- **路径**：/api/user/send-sms
- **描述**：向指定手机号发送验证码，用于注册或登录验证
- **权限**：无需认证

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| username | string | 是 | 手机号码 | "13800138000" |
| source | string | 是 | 验证码用途（register/login） | "login" |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/send-sms" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "13800138000",
    "source": "login"
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "验证码发送成功",
  "data": {
    "success": true,
    "message": "验证码已发送到您的手机，请注意查收"
  }
}
```

**错误响应**：
```json
{
  "code": 400,
  "msg": "手机号格式错误",
  "data": null
}
```

#### 业务逻辑
1. 验证手机号格式
2. 检查发送频率限制（60秒内只能发送一次）
3. 生成6位数字验证码
4. 调用短信服务发送验证码
5. 将验证码存储到Redis，设置5分钟过期时间

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 手机号格式错误 | 检查手机号格式 |
| 429 | 发送频率过快 | 等待60秒后重试 |
| 500 | 短信服务异常 | 联系技术支持 |

---

### 3.2 验证码登录

#### 基本信息
- **方法**：POST
- **路径**：/api/user/login
- **描述**：使用手机号和验证码进行登录，新用户自动注册
- **权限**：无需认证

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| username | string | 是 | 手机号码 | "13800138000" |
| code | string | 是 | 短信验证码 | "123456" |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "13800138000",
    "code": "123456"
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 123,
      "username": "13800138000",
      "nickname": "",
      "avatar": "",
      "gender": "0",
      "level": 1,
      "vip_status": "0",
      "balance": 0.0,
      "diamond": 0
    },
    "is_new_user": true
  }
}
```

**错误响应**：
```json
{
  "code": 401,
  "msg": "验证码错误或已过期",
  "data": null
}
```

#### 业务逻辑
1. 验证手机号格式
2. 从Redis获取验证码并验证
3. 查询用户是否存在
4. 如果用户不存在，创建新用户（默认密码123456）
5. 生成JWT令牌
6. 更新用户最后登录时间和IP
7. 返回用户信息和令牌

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 参数格式错误 | 检查请求参数 |
| 401 | 验证码错误或已过期 | 重新获取验证码 |
| 500 | 系统内部错误 | 联系技术支持 |

---

### 3.3 密码登录

#### 基本信息
- **方法**：POST
- **路径**：/api/user/password-login
- **描述**：使用用户名和密码进行登录
- **权限**：无需认证

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| username | string | 是 | 用户名（手机号） | "13800138000" |
| password | string | 是 | 登录密码 | "123456" |
| remember_me | boolean | 否 | 是否记住登录状态 | true |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/password-login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "13800138000",
    "password": "123456",
    "remember_me": true
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 123,
      "username": "13800138000",
      "nickname": "用户昵称",
      "avatar": "http://example.com/avatar.jpg",
      "gender": "1",
      "level": 5,
      "vip_status": "1",
      "balance": 100.5,
      "diamond": 50
    },
    "expires_in": 86400
  }
}
```

**错误响应**：
```json
{
  "code": 401,
  "msg": "用户名或密码错误",
  "data": null
}
```

#### 业务逻辑
1. 验证用户名和密码格式
2. 根据用户名查询用户信息
3. 验证密码（MD5加密对比）
4. 检查用户状态（是否被封禁、冻结）
5. 生成JWT令牌（记住登录状态时延长有效期）
6. 更新最后登录时间和IP
7. 如果记住登录状态，将令牌存储到Redis

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 参数格式错误 | 检查用户名和密码格式 |
| 401 | 用户名或密码错误 | 检查登录凭据 |
| 403 | 账号已被封禁或冻结 | 联系客服处理 |
| 500 | 系统内部错误 | 联系技术支持 |

---

### 3.4 修改密码

#### 基本信息
- **方法**：POST
- **路径**：/api/user/update-password
- **描述**：修改用户登录密码
- **权限**：需要JWT认证

#### 请求头
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| Authorization | string | 是 | JWT令牌 | "Bearer eyJhbGciOiJIUzI1NiIs..." |

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| password | string | 是 | 新密码（6-20位） | "newpassword123" |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/update-password" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..." \
  -d '{
    "password": "newpassword123"
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "密码修改成功",
  "data": {
    "success": true,
    "message": "密码已成功修改，请使用新密码登录"
  }
}
```

**错误响应**：
```json
{
  "code": 400,
  "msg": "密码格式不符合要求",
  "data": null
}
```

#### 业务逻辑
1. 验证JWT令牌有效性
2. 验证新密码格式（6-20位，包含字母和数字）
3. 对新密码进行MD5加密
4. 更新数据库中的密码
5. 清除用户的所有登录令牌（强制重新登录）

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 密码格式不符合要求 | 密码应为6-20位，包含字母和数字 |
| 401 | 未授权访问 | 请先登录 |
| 500 | 系统内部错误 | 联系技术支持 |

---

### 3.5 完善用户信息

#### 基本信息
- **方法**：POST
- **路径**：/api/user/improve-info
- **描述**：更新用户个人信息
- **权限**：需要JWT认证

#### 请求头
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| Authorization | string | 是 | JWT令牌 | "Bearer eyJhbGciOiJIUzI1NiIs..." |

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| nickname | string | 否 | 用户昵称（2-20字符） | "小明" |
| gender | string | 否 | 性别（0-保密,1-男,2-女） | "1" |
| voice_tag | string | 否 | 声音标签（逗号分隔） | "温柔,磁性" |
| interest_tag | string | 否 | 兴趣标签（逗号分隔） | "音乐,电影,旅行" |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/improve-info" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..." \
  -d '{
    "nickname": "小明",
    "gender": "1",
    "voice_tag": "温柔,磁性",
    "interest_tag": "音乐,电影,旅行"
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "信息更新成功",
  "data": {
    "user": {
      "id": 123,
      "username": "13800138000",
      "nickname": "小明",
      "avatar": "",
      "gender": "1",
      "voice_tag": "温柔,磁性",
      "interest_tags": "音乐,电影,旅行",
      "level": 1,
      "vip_status": "0"
    }
  }
}
```

**错误响应**：
```json
{
  "code": 400,
  "msg": "昵称长度不符合要求",
  "data": null
}
```

#### 业务逻辑
1. 验证JWT令牌有效性
2. 验证各字段格式和长度
3. 检查昵称是否重复（如果提供）
4. 更新用户信息到数据库
5. 返回更新后的用户信息

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 参数格式错误 | 检查各字段格式和长度 |
| 401 | 未授权访问 | 请先登录 |
| 409 | 昵称已被使用 | 更换其他昵称 |
| 500 | 系统内部错误 | 联系技术支持 |

---

### 3.6 关注用户

#### 基本信息
- **方法**：POST
- **路径**：/api/user/follow
- **描述**：关注指定用户
- **权限**：需要JWT认证

#### 请求头
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| Authorization | string | 是 | JWT令牌 | "Bearer eyJhbGciOiJIUzI1NiIs..." |

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| followed_id | integer | 是 | 被关注用户ID | 456 |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/follow" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..." \
  -d '{
    "followed_id": 456
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "关注成功",
  "data": {
    "success": true,
    "message": "已成功关注该用户",
    "followed_user": {
      "id": 456,
      "nickname": "被关注用户",
      "avatar": "http://example.com/avatar.jpg"
    }
  }
}
```

**错误响应**：
```json
{
  "code": 409,
  "msg": "已经关注过该用户",
  "data": null
}
```

#### 业务逻辑
1. 验证JWT令牌有效性
2. 检查被关注用户是否存在
3. 检查是否已经关注过该用户
4. 检查是否尝试关注自己
5. 创建关注关系记录
6. 更新双方的关注数和粉丝数
7. 发送关注通知（可选）

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 参数错误 | 检查用户ID格式 |
| 401 | 未授权访问 | 请先登录 |
| 404 | 用户不存在 | 检查用户ID是否正确 |
| 409 | 已经关注过该用户 | 无需重复关注 |
| 422 | 不能关注自己 | 选择其他用户关注 |

---

### 3.7 取消关注

#### 基本信息
- **方法**：POST
- **路径**：/api/user/unfollow
- **描述**：取消关注指定用户
- **权限**：需要JWT认证

#### 请求头
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| Authorization | string | 是 | JWT令牌 | "Bearer eyJhbGciOiJIUzI1NiIs..." |

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| followed_id | integer | 是 | 被取消关注用户ID | 456 |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/api/user/unfollow" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIs..." \
  -d '{
    "followed_id": 456
  }'
```

#### 响应格式
**成功响应**：
```json
{
  "code": 200,
  "msg": "取消关注成功",
  "data": {
    "success": true,
    "message": "已取消关注该用户"
  }
}
```

**错误响应**：
```json
{
  "code": 404,
  "msg": "未关注过该用户",
  "data": null
}
```

#### 业务逻辑
1. 验证JWT令牌有效性
2. 检查关注关系是否存在
3. 删除关注关系记录
4. 更新双方的关注数和粉丝数
5. 发送取消关注通知（可选）

#### 错误码说明
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 400 | 参数错误 | 检查用户ID格式 |
| 401 | 未授权访问 | 请先登录 |
| 404 | 未关注过该用户 | 无需取消关注 |
| 500 | 系统内部错误 | 联系技术支持 |

## 4. 数据模型

### 4.1 用户模型 (User)

```go
type User struct {
    Id            uint64    `json:"id"`              // 用户唯一ID
    Username      string    `json:"username"`        // 登录账号(手机号)
    Password      string    `json:"-"`               // 登录密码(不返回给客户端)
    Nickname      string    `json:"nickname"`        // 用户昵称
    Avatar        string    `json:"avatar"`          // 头像URL
    Gender        string    `json:"gender"`          // 性别(0-保密,1-男,2-女)
    VoiceTag      string    `json:"voice_tag"`       // 声音标签(逗号分隔)
    InterestTags  string    `json:"interest_tags"`   // 兴趣标签(逗号分隔)
    Level         int16     `json:"level"`           // 用户等级
    VipStatus     string    `json:"vip_status"`      // 会员状态(0-非会员,1-月会员,2-年会员)
    VipExpireTime time.Time `json:"vip_expire_time"` // 会员过期时间
    Balance       float64   `json:"balance"`         // 虚拟币余额
    Diamond       int16     `json:"diamond"`         // 钻石数量
    RegisterTime  time.Time `json:"register_time"`   // 注册时间
    LastLoginTime time.Time `json:"last_login_time"` // 最后登录时间
    LastLoginIp   string    `json:"last_login_ip"`   // 最后登录IP
    Status        string    `json:"status"`          // 账号状态(0-正常,1-封禁,2-冻结,3-禁言)
    IsAuth        string    `json:"is_auth"`         // 实名认证状态
}
```

### 4.2 用户关注模型 (UserFollow)

```go
type UserFollow struct {
    Id         uint64    `json:"id"`          // 关注记录ID
    FollowerId uint64    `json:"follower_id"` // 关注者用户ID
    FollowedId uint64    `json:"followed_id"` // 被关注者用户ID
    CreatedAt  time.Time `json:"created_at"`  // 关注时间
    Status     int8      `json:"status"`      // 关注状态(0-正常,1-已取消)
}
```

### 4.3 枚举值定义

#### 性别枚举
| 值 | 描述 |
|----|------|
| "0" | 保密 |
| "1" | 男 |
| "2" | 女 |

#### 用户状态枚举
| 值 | 描述 |
|----|------|
| "0" | 正常 |
| "1" | 封禁 |
| "2" | 冻结 |
| "3" | 禁言 |

#### 会员状态枚举
| 值 | 描述 |
|----|------|
| "0" | 非会员 |
| "1" | 月会员 |
| "2" | 年会员 |

#### 实名认证状态枚举
| 值 | 描述 |
|----|------|
| "0" | 未认证 |
| "1" | 已认证 |
| "2" | 认证失败 |

## 5. 业务流程

### 5.1 用户注册登录流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant A as API层
    participant S as Server层
    participant R as Redis
    participant D as 数据库
    participant SMS as 短信服务

    C->>A: 1. 发送验证码请求
    A->>SMS: 2. 调用短信服务
    SMS-->>A: 3. 发送成功
    A->>R: 4. 存储验证码
    A-->>C: 5. 返回发送成功

    C->>A: 6. 验证码登录请求
    A->>R: 7. 验证验证码
    A->>S: 8. 查询/创建用户
    S->>D: 9. 数据库操作
    D-->>S: 10. 返回用户信息
    S-->>A: 11. 返回用户数据
    A->>A: 12. 生成JWT令牌
    A-->>C: 13. 返回登录成功
```

### 5.2 用户信息完善流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant A as API层
    participant S as Server层
    participant D as 数据库

    C->>A: 1. 提交用户信息
    A->>A: 2. JWT令牌验证
    A->>A: 3. 参数格式验证
    A->>S: 4. 调用更新服务
    S->>D: 5. 检查昵称重复
    D-->>S: 6. 返回检查结果
    S->>D: 7. 更新用户信息
    D-->>S: 8. 返回更新结果
    S-->>A: 9. 返回用户数据
    A-->>C: 10. 返回更新成功
```

### 5.3 用户关注流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant A as API层
    participant S as Server层
    participant D as 数据库
    participant N as 通知服务

    C->>A: 1. 关注用户请求
    A->>A: 2. JWT令牌验证
    A->>S: 3. 调用关注服务
    S->>D: 4. 检查用户存在
    S->>D: 5. 检查关注状态
    S->>D: 6. 创建关注记录
    S->>D: 7. 更新关注统计
    D-->>S: 8. 返回操作结果
    S->>N: 9. 发送关注通知
    S-->>A: 10. 返回关注成功
    A-->>C: 11. 返回成功响应
```

## 6. 错误码汇总

### 6.1 通用错误码
| 错误码 | 描述 | HTTP状态码 |
|--------|------|------------|
| 200 | 成功 | 200 |
| 400 | 请求参数错误 | 400 |
| 401 | 未授权访问 | 401 |
| 403 | 禁止访问 | 403 |
| 404 | 资源不存在 | 404 |
| 409 | 资源冲突 | 409 |
| 422 | 业务逻辑错误 | 422 |
| 429 | 请求频率过快 | 429 |
| 500 | 服务器内部错误 | 500 |

### 6.2 用户模块特定错误码
| 错误码 | 描述 | 解决方案 |
|--------|------|----------|
| 1001 | 手机号格式错误 | 检查手机号格式 |
| 1002 | 验证码错误或已过期 | 重新获取验证码 |
| 1003 | 验证码发送频率过快 | 等待60秒后重试 |
| 1004 | 用户名或密码错误 | 检查登录凭据 |
| 1005 | 账号已被封禁 | 联系客服处理 |
| 1006 | 账号已被冻结 | 联系客服处理 |
| 1007 | 密码格式不符合要求 | 密码应为6-20位 |
| 1008 | 昵称已被使用 | 更换其他昵称 |
| 1009 | 昵称长度不符合要求 | 昵称应为2-20字符 |
| 1010 | 已经关注过该用户 | 无需重复关注 |
| 1011 | 未关注过该用户 | 无需取消关注 |
| 1012 | 不能关注自己 | 选择其他用户关注 |
| 1013 | JWT令牌无效或已过期 | 重新登录 |
| 1014 | 短信服务异常 | 联系技术支持 |

## 7. 测试用例

### 7.1 发送短信验证码测试

```bash
# 正常发送
curl -X POST "http://localhost:8080/api/user/send-sms" \
  -H "Content-Type: application/json" \
  -d '{"username": "13800138000", "source": "login"}'

# 手机号格式错误
curl -X POST "http://localhost:8080/api/user/send-sms" \
  -H "Content-Type: application/json" \
  -d '{"username": "1380013800", "source": "login"}'

# 缺少必填参数
curl -X POST "http://localhost:8080/api/user/send-sms" \
  -H "Content-Type: application/json" \
  -d '{"username": "13800138000"}'
```

### 7.2 用户登录测试

```bash
# 验证码登录成功
curl -X POST "http://localhost:8080/api/user/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "13800138000", "code": "123456"}'

# 密码登录成功
curl -X POST "http://localhost:8080/api/user/password-login" \
  -H "Content-Type: application/json" \
  -d '{"username": "13800138000", "password": "123456", "remember_me": true}'

# 验证码错误
curl -X POST "http://localhost:8080/api/user/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "13800138000", "code": "000000"}'
```

### 7.3 用户信息管理测试

```bash
# 完善用户信息
curl -X POST "http://localhost:8080/api/user/improve-info" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{
    "nickname": "测试用户",
    "gender": "1",
    "voice_tag": "温柔,磁性",
    "interest_tag": "音乐,电影"
  }'

# 修改密码
curl -X POST "http://localhost:8080/api/user/update-password" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"password": "newpassword123"}'
```

### 7.4 用户关注测试

```bash
# 关注用户
curl -X POST "http://localhost:8080/api/user/follow" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"followed_id": 456}'

# 取消关注
curl -X POST "http://localhost:8080/api/user/unfollow" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"followed_id": 456}'
```

## 8. 版本信息

- **当前版本**：v1.0
- **最后更新**：2024年1月
- **维护者**：后端开发团队
- **联系方式**：backend@example.com

## 9. 更新日志

### v1.0 (2024-01-01)
- 初始版本发布
- 实现用户注册登录功能
- 实现用户信息管理功能
- 实现用户关注功能
- 完善接口文档和测试用例